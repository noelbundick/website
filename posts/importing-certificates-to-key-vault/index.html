<!doctype html><html lang=en-us><head><title>Importing Certificates to Key Vault | Noel Bundick</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="I&rsquo;ve found that creating a secure Service Fabric cluster can be a challenge - primarily because of the required interaction with Key Vault. In my Service Fabric Cluster Quickstart post, I shared how the latest Azure PowerShell updates make it much easier to get up and running. That works great for dev clusters, but you&rsquo;ll really want to use an ARM template for any production environments so you can reap the benefits of repeatable declarative deployments."><meta name=generator content="Hugo 0.109.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=/fontawesome/css/brands.min.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/tags>Tags</a></nav><main class=main><section id=single><h1 class=title>Importing Certificates to Key Vault</h1><div class=tip><time datetime="2017-06-13 16:19:09 +0000 UTC">Jun 13, 2017</time>
<span class=split>¬∑</span>
<span>1182 words</span>
<span class=split>¬∑</span>
<span>6 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#creating-a-key-vault>Creating a Key Vault</a></li><li><a href=#key-vault-generated-certificates>Key Vault-generated Certificates</a></li><li><a href=#self-signed--bring-your-own-certificates>Self-signed / Bring-your-own Certificates</a></li><li><a href=#required-fields-for-arm-deployment>Required Fields for ARM Deployment</a></li></ul><ul><li><a href=#creating-a-key-vault-1>Creating a Key Vault</a></li><li><a href=#key-vault-generated-certificates-1>Key Vault-generated Certificates</a></li><li><a href=#self-signed--bring-your-own-certificates-1>Self-signed / Bring-your-own Certificates</a></li><li><a href=#required-fields-for-arm-deployment-1>Required Fields for ARM Deployment</a></li></ul><ul><li><a href=#azure-cli-on-powershell>Azure CLI on PowerShell</a></li><li><a href=#azure-powershell-on-linux>Azure PowerShell on Linux</a></li><li><a href=#azure-cli-on-command-prompt>Azure CLI on Command Prompt</a></li></ul></nav></div></details></aside><div class=content><p>I&rsquo;ve found that creating a secure Service Fabric cluster can be a challenge - primarily because of the required interaction with Key Vault. In my <a href=/posts/service-fabric-cluster-quickstart/>Service Fabric Cluster Quickstart</a> post, I shared how the latest Azure PowerShell updates make it much easier to get up and running. That works great for dev clusters, but you&rsquo;ll really want to use an ARM template for any production environments so you can reap the benefits of repeatable declarative deployments.</p><p>This means that you&rsquo;ve still got to figure out how to get your certificate into KeyVault and reference it properly. I&rsquo;ve endured the pain on your behalf. This post will give you an easy to follow guide to get a certificate into Key Vault, then collect the parameters you&rsquo;ll need for ARM template deployment. I&rsquo;ve compiled the steps for both Azure CLI and Azure PowerShell - choose the method that works best for you!</p><h1 id=tools>Tools <a href=#tools class=anchor>üîó</a></h1><ul><li><a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli target=_blank rel=noopener>Azure CLI</a></li><li><a href=https://www.powershellgallery.com/packages/AzureRM/4.1.0 target=_blank rel=noopener>Azure PowerShell</a></li></ul><h1 id=azure-cli>Azure CLI <a href=#azure-cli class=anchor>üîó</a></h1><h2 id=creating-a-key-vault>Creating a Key Vault <a href=#creating-a-key-vault class=anchor>üîó</a></h2><p>I&rsquo;m going to assume you&rsquo;re starting from scratch. To create a Key Vault</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># Create a Resource Group to hold your Key Vault(s)</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Note this should be separate from your other resources so you can delete those other resource groups without impacting your registered certs</span>
</span></span><span style=display:flex><span>az group create -n keyvault -l southcentralus
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Create a Key Vault to hold your secrets</span>
</span></span><span style=display:flex><span>az keyvault create -n noel-temp -g keyvault --enabled-for-deployment --enabled-for-disk-encryption --enabled-for-template-deployment
</span></span></code></pre></div><blockquote><p>Note - your Key Vault should live in the same region as your compute resources. You can pass <code>--location &lt;targetRegion></code> to <code>az keyvault create</code> if you need to create the vault in a different region than the resource group</p></blockquote><h2 id=key-vault-generated-certificates>Key Vault-generated Certificates <a href=#key-vault-generated-certificates class=anchor>üîó</a></h2><p>It&rsquo;s pretty simple to let Key Vault do all the work for you, then download the cert locally when you need it. If you use a supported CA, you can even configure Key Vault to enroll for certificates on your behalf - no leaking of keys! For simplicity, the policy in these examples will be set to generate self-signed certs from Key Vault.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># Tell Key Vault to create a certificate with the default policy</span>
</span></span><span style=display:flex><span>az keyvault certificate create --vault-name noel-temp -n cert1 -p <span style=color:#2aa198>&#34;</span><span style=color:#719e07>$(</span>az keyvault certificate get-default-policy -o json<span style=color:#719e07>)</span><span style=color:#2aa198>&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Download the secret (private key information) associated with the cert</span>
</span></span><span style=display:flex><span>az keyvault secret download --vault-name noel-temp -n cert1 -e base64 -f cert1.pfx
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># If you&#39;re on Linux, odds are you&#39;re not using .pfx format</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Convert from PFX to PEM format. Import password is blank</span>
</span></span><span style=display:flex><span>openssl pkcs12 -in cert1.pfx -out test.pem -outkey test.key -nodes
</span></span></code></pre></div><blockquote><p>Note - The PFX has no password by default, and I&rsquo;ve specified <code>-nodes</code>, so the PEM has an unencrypted private key as well. For production deployments, use appropriate measures to secure your certs.</p></blockquote><h2 id=self-signed--bring-your-own-certificates>Self-signed / Bring-your-own Certificates <a href=#self-signed--bring-your-own-certificates class=anchor>üîó</a></h2><p>You may want/need to sign your certs externally. Or perhaps your CA doesn&rsquo;t support integration with Key Vault. In these cases, you&rsquo;ll have an existing cert that you&rsquo;ll need to import into Key Vault. This is also pretty easy once you know the magic words.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># Create a new self-signed cert, with a custom FQDN</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Note: As of 5/7/17, KeyVault supports only 2048 bit RSA keys</span>
</span></span><span style=display:flex><span>openssl req -x509 -newkey rsa:2048 -subj <span style=color:#2aa198>&#34;/CN=mycluster.southcentralus.cloudapp.azure.com&#34;</span> -days <span style=color:#2aa198>365</span> -out cert2.crt -keyout cert2.pem -passout pass:Password!
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Convert PEM to PFX</span>
</span></span><span style=display:flex><span>openssl pkcs12 -export -in cert2.crt -inkey cert2.pem  -passin pass:Password! -out cert2.pfx -passout pass:Password!
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Upload to Key Vault</span>
</span></span><span style=display:flex><span>az keyvault certificate import --vault-name noel-temp -n cert2 -f cert2.pfx --password Password!
</span></span></code></pre></div><h2 id=required-fields-for-arm-deployment>Required Fields for ARM Deployment <a href=#required-fields-for-arm-deployment class=anchor>üîó</a></h2><p>Cool, you&rsquo;ve got a cert in Key Vault. You&rsquo;ll need a few fields for your ARM template. Here&rsquo;s how to get them</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># Source vault id</span>
</span></span><span style=display:flex><span>az keyvault show -n noel-temp --query id -o tsv
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Certificate thumbprint</span>
</span></span><span style=display:flex><span>az keyvault certificate show --vault-name noel-temp -n cert1 --query x509ThumbprintHex -o tsv
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Certificate url</span>
</span></span><span style=display:flex><span>az keyvault certificate show --vault-name noel-temp -n cert1 --query sid -o tsv
</span></span></code></pre></div><h1 id=azure-powershell>Azure PowerShell <a href=#azure-powershell class=anchor>üîó</a></h1><h2 id=creating-a-key-vault-1>Creating a Key Vault <a href=#creating-a-key-vault-1 class=anchor>üîó</a></h2><p>I&rsquo;m going to assume you&rsquo;re starting from scratch. Here&rsquo;s how to get started with a Key Vault</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># Create a Resource Group to hold your Key Vault(s)</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Note this should be separate from your other resources so you can delete those other resource groups without impacting your registered certs</span>
</span></span><span style=display:flex><span><span style=color:#b58900>New-AzureRmResourceGroup</span> -Name keyvault -Location southcentralus
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Create a Key Vault to hold your secrets</span>
</span></span><span style=display:flex><span><span style=color:#b58900>New-AzureRmKeyVault</span> -VaultName <span style=color:#b58900>noel-temp</span> -ResourceGroupName keyvault -Location southcentralus -EnabledForDeployment -EnabledForDiskEncryption -EnabledForTemplateDeployment
</span></span></code></pre></div><h2 id=key-vault-generated-certificates-1>Key Vault-generated Certificates <a href=#key-vault-generated-certificates-1 class=anchor>üîó</a></h2><p>It&rsquo;s pretty simple to let Key Vault do all the work for you, then download the cert locally when you need it. If you use a supported CA, you can even configure Key Vault to enroll for certificates on your behalf. No leaking of keys! For simplicity, the policy in these examples will be set to generate self-signed certs from Key Vault.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># Have Key Vault create the certificate with a simple policy</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$policy</span> = <span style=color:#b58900>New-AzureKeyVaultCertificatePolicy</span> -SubjectName <span style=color:#2aa198>&#34;CN=mycluster.southcentralus.cloudapp.azure.com&#34;</span> -IssuerName Self -ValidityInMonths <span style=color:#2aa198>12</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Add-AzureKeyVaultCertificate</span> -VaultName <span style=color:#b58900>noel-temp</span> -Name cert1 -CertificatePolicy <span style=color:#268bd2>$policy</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Download the secret (private key information) associated with the cert</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$secret</span> = <span style=color:#b58900>Get-AzureKeyVaultSecret</span> -VaultName <span style=color:#b58900>noel-temp</span> -Name cert1
</span></span><span style=display:flex><span><span style=color:#268bd2>$secretBytes</span> = [<span style=color:#cb4b16>System.Convert</span>]::FromBase64String(<span style=color:#268bd2>$secret</span>.SecretValueText)
</span></span><span style=display:flex><span>[<span style=color:#cb4b16>System.IO.File</span>]::WriteAllBytes(<span style=color:#2aa198>&#34;C:\temp\cert1.pfx&#34;</span>, <span style=color:#268bd2>$secretBytes</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Import the certificate to CurrentUser\My</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Import-PfxCertificate</span> -FilePath C:\temp\cert1.pfx -CertStoreLocation cert:\CurrentUser\My -Exportable
</span></span></code></pre></div><blockquote><p>Note - The PFX has no password by default. For production deployments, use appropriate measures to secure your certs.</p></blockquote><h2 id=self-signed--bring-your-own-certificates-1>Self-signed / Bring-your-own Certificates <a href=#self-signed--bring-your-own-certificates-1 class=anchor>üîó</a></h2><p>You may want/have to sign your certs locally. Or perhaps your CA doesn&rsquo;t support integration with Key Vault. In these cases, you&rsquo;ll have an existing cert that you&rsquo;ll need to import into Key Vault. This is also pretty easy once you know the magic words.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># Create a new self-signed cert in CurrentUser\My</span>
</span></span><span style=display:flex><span><span style=color:#b58900>New-SelfSignedCertificate</span> -Subject <span style=color:#2aa198>&#34;CN=mycluster.southcentralus.cloudapp.azure.com&#34;</span> -CertStoreLocation cert:\CurrentUser\My
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Export the cert to a PFX with password</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$password</span> = <span style=color:#b58900>ConvertTo-SecureString</span> <span style=color:#2aa198>&#34;Password!&#34;</span> -AsPlainText -Force
</span></span><span style=display:flex><span><span style=color:#b58900>Export-PfxCertificate</span> -Cert <span style=color:#2aa198>&#34;cert:\CurrentUser\My\</span>$(<span style=color:#268bd2>$cert</span>.Thumbprint)<span style=color:#2aa198>&#34;</span> -FilePath C:\temp\cert2.pfx -Password <span style=color:#268bd2>$password</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Upload to Key Vault</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Import-AzureKeyVaultCertificate</span> -VaultName <span style=color:#b58900>noel-temp</span> -Name cert2 -FilePath C:\temp\cert2.pfx -Password <span style=color:#268bd2>$password</span>
</span></span></code></pre></div><h2 id=required-fields-for-arm-deployment-1>Required Fields for ARM Deployment <a href=#required-fields-for-arm-deployment-1 class=anchor>üîó</a></h2><p>Cool, you&rsquo;ve got a cert in Key Vault. You&rsquo;ll need a few fields for your ARM template. Here&rsquo;s how to get them</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># Source vault id</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Get-AzureRmKeyVault</span> -Name <span style=color:#b58900>noel-temp</span> | <span style=color:#b58900>select </span>ResourceId
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Certificate thumbprint</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Get-AzureKeyVaultCertificate</span> -VaultName <span style=color:#b58900>noel-temp</span> -Name cert1 | <span style=color:#b58900>select </span>Thumbprint
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#586e75># Certificate Url</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Get-AzureKeyVaultCertificate</span> -VaultName <span style=color:#b58900>noel-temp</span> -Name cert1 | <span style=color:#b58900>select </span>SecretId
</span></span></code></pre></div><h1 id=non-recommended-methods>Non-Recommended Methods <a href=#non-recommended-methods class=anchor>üîó</a></h1><p>I&rsquo;ve tried some other ways, with various levels of failure and frustration. I&rsquo;m going to list my bad ideas to save you the trouble</p><h2 id=azure-cli-on-powershell>Azure CLI on PowerShell <a href=#azure-cli-on-powershell class=anchor>üîó</a></h2><p>This one is actually more or less supported, and it&rsquo;s super easy to stumble into this trap. Watch out - you&rsquo;ll spend far more time fighting the tooling (escaping quotes, etc) than actually getting work done. The resulting code is also awful to read. A working example that I was too stubborn to put down</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># Don&#39;t do this! Just use native PowerShell commands</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$defaultPolicy</span> = az keyvault certificate <span style=color:#b58900>get-default</span>-policy -o json
</span></span><span style=display:flex><span>az keyvault certificate create --vault-name <span style=color:#b58900>noel-temp</span> -n cert3 -p $(<span style=color:#2aa198>&#34;&#34;&#34;&#34;</span> + <span style=color:#268bd2>$defaultPolicy</span>.Replace(<span style=color:#2aa198>&#34;&#34;&#34;&#34;</span>, <span style=color:#2aa198>&#34;&#34;&#34;&#34;&#34;&#34;</span>) + <span style=color:#2aa198>&#34;&#34;&#34;&#34;</span>)
</span></span></code></pre></div><h2 id=azure-powershell-on-linux>Azure PowerShell on Linux <a href=#azure-powershell-on-linux class=anchor>üîó</a></h2><p>Basically there are <strong>very</strong> limited commands and modules available, and AzureRM isn&rsquo;t one of them.</p><h2 id=azure-cli-on-command-prompt>Azure CLI on Command Prompt <a href=#azure-cli-on-command-prompt class=anchor>üîó</a></h2><p>NOPE. Don&rsquo;t do it.</p><p><p class=markdown-image><img src=/posts/importing-certificates-to-key-vault/nope.gif alt="Just no"></p></p><h1 id=links>Links <a href=#links class=anchor>üîó</a></h1><ul><li><a href=https://blogs.technet.microsoft.com/kv/2016/09/26/get-started-with-azure-key-vault-certificates/ target=_blank rel=noopener>Get Started with Azure Key Vault Certificates</a></li></ul></div><div class=tags><a href=/tags/azure>azure</a>
<a href=/tags/key-vault>key vault</a></div></section></main><section><ul class=post-list><li>2021-10-14
<a href=/gists/optimizing-rust-container-builds/>Optimizing Rust container builds<h2></h2></a></li><li>2021-09-19
<a href=/gists/wsl2-container-development-with-moby/>WSL2 container development with Moby<h2></h2></a></li><li>2019-12-17
<a href=/gists/rdp-from-wsl/>RDP from WSL<h2></h2></a></li><li>2019-06-28
<a href=/gists/how-to-use-docker-build-secrets/>How to use Docker build secrets<h2></h2></a></li><li>2019-06-12
<a href=/gists/consuming-packages-from-a-private-azure-pipelines-python-artifact-feed/>Consuming packages from a private Azure Pipelines Python artifact feed<h2></h2></a></li><li>2019-01-13
<a href=/gists/gists-as-a-content-management-system/>Gists as a content management system<h2></h2></a></li><li>2019-01-12
<a href=/gists/azure-function-w--user-assigned-identity/>Azure Function w/ User Assigned Identity<h2></h2></a></li><li>2018-12-15
<a href=/gists/secure-code-execution-via-arm-template-and-azure-container-instances/>Secure code execution via ARM template and Azure Container Instances<h2></h2></a></li><li>2018-12-10
<a href=/gists/azure-redis-cli/>azure-redis-cli<h2></h2></a></li><li>2018-12-10
<a href=/gists/resize-azure-cloud-shell-storage/>Resize Azure Cloud Shell storage<h2></h2></a></li></ul></section><footer id=footer><div id=social><a class=symbol rel=me href=https://www.github.com/noelbundick><i class="fa-brands fa-github"></i></a>
<a class=symbol rel=me href=https://www.linkedin.com/in/noelbundick/><i class="fa-brands fa-linkedin"></i></a>
<a class=symbol rel=me href=https://hachyderm.io/@acanthamoeba><i class="fa-brands fa-mastodon"></i></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Noel Bundick</div></footer></body></html>