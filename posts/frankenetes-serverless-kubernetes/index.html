<!doctype html><html lang=en-us><head><title>Frankenetes! Serverless Kubernetes | Noel Bundick</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="In a recent post, I showed how it was possible to run the Kubernetes control plane components on Azure Container Instances. The cloud moves fast, and there have been some great improvements to ACI in the last month. In keeping up with the times, I&rsquo;ve upgraded Frankenetes from just a virtual control plane to a full-blown virtual cluster! Look out, hacks incoming!
 Check out the code on GitHub: https://github.com/noelbundick/frankenetes"><meta name=generator content="Hugo 0.99.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=/fontawesome/css/brands.min.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a></nav><main class=main><section id=single><h1 class=title>Frankenetes! Serverless Kubernetes</h1><div class=tip><time datetime="2018-02-24 00:00:00 +0000 UTC">Feb 24, 2018</time>
<span class=split>¬∑</span>
<span>672 words</span>
<span class=split>¬∑</span>
<span>4 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#dns>DNS</a></li><li><a href=#virtual-kubelet>Virtual-Kubelet</a><ul><li><a href=#running-pods>Running pods</a></li></ul></li><li><a href=#whats-next>What&rsquo;s next?</a><ul><li><a href=#pausingrestarting>Pausing/restarting</a></li><li><a href=#tls>TLS</a></li><li><a href=#open-service-broker-for-azure>Open Service Broker for Azure</a></li></ul></li></ul></nav></div></details></aside><div class=content><p>In a <a href=/posts/frankenetes-running-the-kubernetes-control-plane-on-azure-container-instances/>recent post</a>, I showed how it was possible to run the Kubernetes control plane components on Azure Container Instances. The cloud moves fast, and there have been some <a href=https://azure.microsoft.com/en-us/updates/aci-feb/ target=_blank rel=noopener>great improvements to ACI</a> in the last month. In keeping up with the times, I&rsquo;ve upgraded Frankenetes from just a virtual control plane to a full-blown virtual cluster! Look out, hacks incoming!</p><blockquote><p>Check out the code on GitHub: <a href=https://github.com/noelbundick/frankenetes target=_blank rel=noopener>https://github.com/noelbundick/frankenetes</a></p></blockquote><h2 id=dns>DNS <a href=#dns class=anchor>üîó</a></h2><p>Previously, I was manually creating DNS records to glue my containers together. ACI now lets you specify a <code>--dns-name-label</code> parameter on creation, which is awesome! Here&rsquo;s a code snippet of the new option:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az container create -g frankenetes <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --name etcd <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --image quay.io/coreos/etcd:v3.2.8 <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --ports <span style=color:#2aa198>2379</span> <span style=color:#2aa198>2389</span> <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --location eastus <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --ip-address public <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --dns-name-label frankenetes-etcd <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --command-line <span style=color:#2aa198>&#34;/usr/local/bin/etcd --name=aci --listen-client-urls=http://0.0.0.0:2379 --advertise-client-urls=http://frankenetes-etcd.eastus.azurecontainer.io:2379&#34;</span>
</span></span></code></pre></div><blockquote><p>Note the use of the fully qualified domain name in the startup command. The pattern for DNS names on Azure Container Instances is <code>{DNS name label}.{location}.azurecontainer.io</code></p></blockquote><p>Container groups get automatically assigned a new public IP, and then the DNS name points to it. Other applications (or container groups!) can use the DNS name to access the container. Here&rsquo;s a diagram of how this works in Frankenetes with multiple container groups in play:</p><p><p class=markdown-image><img src=/posts/frankenetes-serverless-kubernetes/dns.png alt="Frankenetes component communication"></p></p><h2 id=virtual-kubelet>Virtual-Kubelet <a href=#virtual-kubelet class=anchor>üîó</a></h2><p>A cluster is no good if you have no nodes to run things on. And since this is a science experiment to see what&rsquo;s possible, I&rsquo;ve added <a href=https://github.com/virtual-kubelet/virtual-kubelet target=_blank rel=noopener>virtual-kubelet</a>, which will give me <strong>even more</strong> container groups!</p><p>Normally you run virtual-kubelet as a pod on your cluster&mldr; but I don&rsquo;t really have one of those yet, so I&rsquo;m running it as yet another Azure Container Instance!</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az container create -g <span style=color:#268bd2>$AZURE_RESOURCE_GROUP</span> <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --name virtual-kubelet <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --image microsoft/virtual-kubelet <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --azure-file-volume-account-name <span style=color:#268bd2>$AZURE_STORAGE_ACCOUNT</span> <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --azure-file-volume-account-key <span style=color:#268bd2>$AZURE_STORAGE_KEY</span> <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --azure-file-volume-share-name virtual-kubelet <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --azure-file-volume-mount-path /etc/virtual-kubelet <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  -e <span style=color:#268bd2>AZURE_AUTH_LOCATION</span><span style=color:#719e07>=</span>/etc/virtual-kubelet/credentials.json <span style=color:#268bd2>ACI_RESOURCE_GROUP</span><span style=color:#719e07>=</span>frankenetes-pods <span style=color:#268bd2>ACI_REGION</span><span style=color:#719e07>=</span><span style=color:#268bd2>$REGION</span> <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span><span style=color:#cb4b16></span>  --command-line <span style=color:#2aa198>&#34;/usr/bin/virtual-kubelet --provider azure --nodename virtual-kubelet --os Linux --kubeconfig /etc/virtual-kubelet/frankenetes.kubeconfig&#34;</span>
</span></span></code></pre></div><blockquote><p>I&rsquo;ve told virtual-kubelet to run all pods for that &ldquo;node&rdquo; in the <code>frankenetes-pods</code> resource group, so I can apply different rules to application container groups than my control plane container groups.</p></blockquote><p>From a Kubernetes perspective, virtual-kubelet is just a node. It talks to the apiserver and listens for the pods that it should be running. When it finds a new one assigned that&rsquo;s not already active, it spins up a new pod.</p><p>I&rsquo;m using the ACI provider to spin up more container groups, but virtual-kubelet is open source and there&rsquo;s also a provider for <a href=https://hyper.sh/ target=_blank rel=noopener>hyper.sh</a>. You could also write your own provider to run containers anywhere you want - another cloud, on bare-metal, to spin up a VM per container, etc. If you like interacting with your apps via the Kubernetes API, it might be a cool way to implement features you need without waiting for upstream support.</p><h3 id=running-pods>Running pods <a href=#running-pods class=anchor>üîó</a></h3><p>VK conveniently maps Kubernetes concepts to ACI concepts, so the following command:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl run nginx --image<span style=color:#719e07>=</span>nginx --port <span style=color:#2aa198>80</span>
</span></span></code></pre></div><p>Results in the following flow to create a new container group with a public IP:</p><p><p class=markdown-image><img src=/posts/frankenetes-serverless-kubernetes/virtual-kubelet.png alt="How virtual-kubelet creates pods"></p></p><h2 id=whats-next>What&rsquo;s next? <a href=#whats-next class=anchor>üîó</a></h2><p>I have absolutely zero legitimate use case for this mad scientist experiment - other than it&rsquo;s fun and I want to see what&rsquo;s possible. Here are some ideas I&rsquo;m kicking around.</p><h3 id=pausingrestarting>Pausing/restarting <a href=#pausingrestarting class=anchor>üîó</a></h3><p>My etcd container is currently mapped to Azure Files, which lets me persist my cluster configuration. I should be able to delete all of my container groups, and spin them back up and let my virtual-kublet create new pods. This would give me an on-demand Kubernetes cluster that&rsquo;s billed by the second. Now that&rsquo;s pretty cool!</p><p>So far, I&rsquo;ve had some problems with the etcd write ahead log when it&rsquo;s mapped to Azure Files. If I can resolve that issue, I think this is good to go!</p><h3 id=tls>TLS <a href=#tls class=anchor>üîó</a></h3><p>This is still <strong>horribly insecure</strong> - please don&rsquo;t run code from my repo and run anything real on it :)</p><h3 id=open-service-broker-for-azure>Open Service Broker for Azure <a href=#open-service-broker-for-azure class=anchor>üîó</a></h3><p>What&rsquo;s more serverless than an ACI-hosted Kubernetes cluster? Using hosted Azure services, of course! <a href=https://github.com/Azure/open-service-broker-azure target=_blank rel=noopener>Open Service Broker for Azure</a> lets you create databases, queues, and more - all from the Kubernetes API.</p></div><div class=tags><a href=/tags/azure>azure</a>
<a href=/tags/kubernetes>kubernetes</a>
<a href=/tags/aci>aci</a></div></section></main><section><ul class=post-list><li>2021-10-14
<a href=/gists/optimizing-rust-container-builds/>Optimizing Rust container builds<h2></h2></a></li><li>2021-09-19
<a href=/gists/wsl2-container-development-with-moby/>WSL2 container development with Moby<h2></h2></a></li><li>2019-12-17
<a href=/gists/rdp-from-wsl/>RDP from WSL<h2></h2></a></li><li>2019-06-28
<a href=/gists/how-to-use-docker-build-secrets/>How to use Docker build secrets<h2></h2></a></li><li>2019-06-12
<a href=/gists/consuming-packages-from-a-private-azure-pipelines-python-artifact-feed/>Consuming packages from a private Azure Pipelines Python artifact feed<h2></h2></a></li><li>2019-01-13
<a href=/gists/gists-as-a-content-management-system/>Gists as a content management system<h2></h2></a></li><li>2019-01-12
<a href=/gists/azure-function-w--user-assigned-identity/>Azure Function w/ User Assigned Identity<h2></h2></a></li><li>2018-12-15
<a href=/gists/secure-code-execution-via-arm-template-and-azure-container-instances/>Secure code execution via ARM template and Azure Container Instances<h2></h2></a></li><li>2018-12-10
<a href=/gists/azure-redis-cli/>azure-redis-cli<h2></h2></a></li><li>2018-12-10
<a href=/gists/resize-azure-cloud-shell-storage/>Resize Azure Cloud Shell storage<h2></h2></a></li></ul></section><footer id=footer><div id=social><a class=symbol href=https://www.github.com/noelbundick><i class="fa-brands fa-github"></i></a>
<a class=symbol href=https://www.linkedin.com/in/noelbundick/><i class="fa-brands fa-linkedin"></i></a>
<a class=symbol href=https://twitter.com/acanthamoeba><i class="fa-brands fa-twitter"></i></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Noel Bundick</div></footer></body></html>