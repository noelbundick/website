<!doctype html><html lang=en-us><head><title>Running Windows Containers with Volumes on Azure Service Fabric | Noel Bundick</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Containers are rapidly becoming the de-facto choice for application packaging, distribution, and execution in the cloud. This newfound flexibility brings new challenges, particularly with stateful workloads like databases. With the advent of container orchestrators, it&rsquo;s no longer a safe assumption that the underlying data for your server is already directly connected to your host. Nodes fail and are dynamically scaled, but your app still needs its data.
Azure Service Fabric is a distributed systems platform that added support for containers a while back."><meta name=generator content="Hugo 0.96.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a></nav><main class=main><section id=single><h1 class=title>Running Windows Containers with Volumes on Azure Service Fabric</h1><div class=tip><time datetime="2018-02-10 15:56:10 +0000 UTC">Feb 10, 2018</time>
<span class=split>¬∑</span>
<span>2060 words</span>
<span class=split>¬∑</span>
<span>10 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#minecraft-i-choose-you>Minecraft, I choose you!</a></li><li><a href=#setting-up-a-cluster>Setting up a cluster</a></li><li><a href=#service-fabric-application-overview>Service Fabric Application Overview</a></li><li><a href=#how-does-the-container-storage-work>How Does the Container Storage Work?</a><ul><li><a href=#the-problem>The problem</a></li><li><a href=#a-solution>A solution</a></li></ul></li><li><a href=#deep-dive>Deep dive</a><ul><li><a href=#1-node-configuration>1. Node configuration</a></li><li><a href=#2-mapping-the-container-volume>2. Mapping the Container Volume</a></li></ul></li><li><a href=#results>Results</a><ul><li><a href=#what-went-well>What Went Well</a></li><li><a href=#what-was-difficult>What Was Difficult</a></li><li><a href=#next-steps>Next Steps</a></li><li><a href=#links>Links!</a></li></ul></li></ul></nav></div></details></aside><div class=content><p>Containers are rapidly becoming the de-facto choice for application packaging, distribution, and execution in the cloud. This newfound flexibility brings new challenges, particularly with stateful workloads like databases. With the advent of container orchestrators, it&rsquo;s no longer a safe assumption that the underlying data for your server is already directly connected to your host. Nodes fail and are dynamically scaled, but your app still needs its data.</p><p><a href=https://docs.microsoft.com/en-us/azure/service-fabric/ target=_blank rel=noopener>Azure Service Fabric</a> is a distributed systems platform that <a href=https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-containers-overview target=_blank rel=noopener>added support</a> for containers a while back. Windows Server 1709 has <a href=https://blogs.msdn.microsoft.com/clustering/2017/08/10/container-storage-support-with-cluster-shared-volumes-csv-storage-spaces-direct-s2d-smb-global-mapping/ target=_blank rel=noopener>greatly improved</a> container storage support options by adding SMB Global Mapping. I&rsquo;ve combined the two with great success and want to share, so that you can understand & replicate the concepts in your own environment.</p><blockquote><p>This post has a sibling repo on GitHub where you can steal code & follow along: <a href=https://github.com/noelbundick/service-fabric-1709-demo target=_blank rel=noopener>https://github.com/noelbundick/service-fabric-1709-demo</a></p></blockquote><h2 id=minecraft-i-choose-you>Minecraft, I choose you! <a href=#minecraft-i-choose-you class=anchor>üîó</a></h2><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/pokeball.jpg alt="Minecraft + Pok√©mon = awesome!"></p></p><p>First off - I need an app that reads & writes local state. Databases and legacy apps are the common pick, but I&rsquo;ll take any excuse I can to play video games at work, so I&rsquo;m choosing the <a href=https://hub.docker.com/r/acanthamoeba/minecraft-server/ target=_blank rel=noopener>Minecraft Windows Container image</a> that I created (as an excuse to play games while learning Windows Containers&mldr;)</p><p>If you feel like something a bit more enterprisey or &ldquo;real world&rdquo;, the <a href=https://hub.docker.com/r/microsoft/mssql-server-windows-developer/ target=_blank rel=noopener>SQL Server Developer Edition for Windows Containers</a> is eerily similar - it also uses a specialized protocol on a specific port, writes data to local storage, you have to accept the EULA, etc. If you want to give it a try, use <code>C:\temp</code> instead of <code>C:\data</code>, and use port <code>1433</code> instead of <code>25565</code></p><h2 id=setting-up-a-cluster>Setting up a cluster <a href=#setting-up-a-cluster class=anchor>üîó</a></h2><p>I have a few options here. First, the <a href=https://portal.azure.com target=_blank rel=noopener>Azure Portal</a> now supports Service Fabric clusters with Server 1709. To kick the tires & get started, it works great. I know I&rsquo;m also interested in trying Hyper-V containers, so I need a VM size that supports <a href=https://azure.microsoft.com/en-us/blog/nested-virtualization-in-azure/ target=_blank rel=noopener>nested virtualization</a> - the <code>Dv3</code> or <code>Ev3</code> series are what I need. I also want to expose port 25565 instead of port 80.</p><p>Okay, that&rsquo;s getting to be a lot of stuff to remember, so I&rsquo;m going to use an ARM template and check it into source control. That way, I can recreate this environment again after I tear down this cluster. The template I&rsquo;m using is available <a href=https://github.com/noelbundick/service-fabric-1709-demo/blob/master/sf-1709/template.json target=_blank rel=noopener>on GitHub</a>.</p><p>I&rsquo;m running the following commands in a PowerShell session:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Create a cluster</span>
</span></span><span style=display:flex><span>az sf cluster create `
</span></span><span style=display:flex><span>  -g sf-1709 `
</span></span><span style=display:flex><span>  -l eastus `
</span></span><span style=display:flex><span>  --template<span style=color:#f92672>-file</span> sf-1709/template.json `
</span></span><span style=display:flex><span>  --parameter<span style=color:#f92672>-file</span> sf-1709/parameters.json `
</span></span><span style=display:flex><span>  --vault-name sf-1709 `
</span></span><span style=display:flex><span>  --certificate-subject-name sf-1709 `
</span></span><span style=display:flex><span>  --certificate-password <span style=color:#e6db74>&#39;Password#1234&#39;</span> `
</span></span><span style=display:flex><span>  --certificate-output-folder .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Import cert</span>
</span></span><span style=display:flex><span>Import-PfxCertificate -FilePath <span style=color:#e6db74>&#39;.\sf-1709201802051346.pfx&#39;</span> -CertStoreLocation <span style=color:#e6db74>&#39;Cert:\CurrentUser\My\&#39;</span>
</span></span></code></pre></div><p>Cool, now I&rsquo;ve got a cluster up and running! Based on the params I gave it, I can visit it in Service Fabric Explorer at <code>https://sf-1709.eastus.cloudapp.azure.com:19080</code></p><blockquote><p>For more cluster creation tips, check out James Sturtevant&rsquo;s post: <a href=http://www.jamessturtevant.com/posts/Creating-a-secure-Service-Fabric-Cluster-in-two-commands/ target=_blank rel=noopener>Creating a secure Service Fabric cluster in two commands</a></p></blockquote><h2 id=service-fabric-application-overview>Service Fabric Application Overview <a href=#service-fabric-application-overview class=anchor>üîó</a></h2><p>First, it&rsquo;s important to understand the big picture of how Service Fabric handles applications, because it&rsquo;s easy to get lost without that initial context. You don&rsquo;t just run a block of code on Service Fabric - you first register it as a type of application. This application type is versioned, and describes what services (containers), parameters, configuration, etc. that are needed to run your app. Then, you create an instance of your app.</p><p>For my Minecraft example, my <code>ApplicationType</code>, version 1.0.0 describes the following:</p><ul><li>My app, by default, has a single instance of a Minecraft <code>Service</code><ul><li>That service runs the <code>acanthamoeba/minecraft-server:nanoserver-1709</code> container, with various environment variables configured</li><li>The service should expose 2 endpoints (TCP ports) - one for the game, and one for administration</li><li>I also need a startup script that runs as Administrator to configure my host before running the container</li></ul></li><li>I want to parameterize my app so I can run lots of Minecraft servers on my cluster - each one will have different ports, data folders, etc.</li><li>Finally, I want to limit how much CPU/memory I allocate to each Minecraft server</li></ul><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/sfoverview.png alt="Service Fabric application types and instances"></p></p><p>The above diagram shows an example representation of how this all works. Minecraft first gets set up as an ApplicationType, and when I create instances, that&rsquo;s when Service Fabric will launch containers & map ports. Think of the ApplicationType like a rubber stamp, and the Instance is the impression I get when I use it on a piece of paper. Those instances can differ (color of ink, type of paper, etc) but each impression came from the same stamp.</p><h2 id=how-does-the-container-storage-work>How Does the Container Storage Work? <a href=#how-does-the-container-storage-work class=anchor>üîó</a></h2><p>Let&rsquo;s do a deep dive into how I set up container storage. Normally with VM Scale Sets, you do something like attach a 100GB data disk to every instance. A naive approach to container volumes might look something like the following:</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/datadisk.png alt="Data disks attached to VMSS"></p></p><blockquote><p>If you&rsquo;re still learning containers, a quick note on container storage: it&rsquo;s important to understand that the data inside a container goes away when the container is destroyed. So first step is always to map a path from inside the container to a path outside the container. Ex: <code>C:\data</code> inside the container pointing to <code>D:\some_folder</code> on the host.</p></blockquote><h3 id=the-problem>The problem <a href=#the-problem class=anchor>üîó</a></h3><p>Okay, looks great! My container can die and I still have my data stored on a disk, backed by Azure Storage - which replicates it multiple times inside my datacenter. Done! Right?</p><p>Wait, hold on - remember how I said container orchestrators introduce new challenges? Let&rsquo;s see what this looks like when a node fails, or needs to be taken offline for security updates:</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/datadisk-failure.png alt="Data disks attached to VMSS - failure"></p></p><p>Not looking so great anymore. My data is indeed safe, but it&rsquo;s logically bound to a specific VM (Node 0). When Service Fabric reschedules my service, it&rsquo;s going to launch on a new node, see no data, and start from scratch. That&rsquo;s bad! Really bad! I&rsquo;m going to get a different set of data every time my service moves across nodes. I&rsquo;m actually in worse shape than if I were to just host my app on a VM at this point - I&rsquo;m tied to a specific node, but I&rsquo;m pretending that I&rsquo;m not.</p><h3 id=a-solution>A solution <a href=#a-solution class=anchor>üîó</a></h3><p>This is where SMB Global Mapping can really help me out. It&rsquo;s like <code>net use</code> on steroids - it can map an SMB share for all users at the OS level. And lucky for me, Azure Files provides a hosted SMB service that persists data independently of any given VM node (or even cluster!). Here&rsquo;s what my storage looks like when I&rsquo;ve configured everything:</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/smbglobalmapping.png alt="SMB Global Mapping"></p></p><p>Cool, so I&rsquo;ve offloaded my data onto Azure Files. Let&rsquo;s run through the same thought experiment - what happens when my container dies in this scenario?</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/smbglobalmapping-failure.png alt="SMB Global Mapping - failure"></p></p><p>Awesome! I&rsquo;ve got the mapping set up on the new node, pointing to the same Azure File share. My container reads the existing data, and can continue on. I&rsquo;ve lost no data, and to the players on my Minecraft server - they&rsquo;ve experienced a disconnect, but didn&rsquo;t completely lose everything in their world.</p><h2 id=deep-dive>Deep dive <a href=#deep-dive class=anchor>üîó</a></h2><p>This section explains what I&rsquo;m doing in the GitHub repo and why.</p><h3 id=1-node-configuration>1. Node configuration <a href=#1-node-configuration class=anchor>üîó</a></h3><p>First up, I need to create the SMB Global Mapping on the host. I could do this on all nodes manually, or with a CustomScript VM extension, but that&rsquo;s really tedious & not very dynamic. What if I want to have multiple Minecraft servers, with each on a different storage account or file share? Or what if I have a business requirement that says each customer&rsquo;s database must be segregated? The smart thing to do is to have Service Fabric configure my node on-demand whenever I want to run a container on it.</p><p>Thankfully, running containers on Service Fabric takes advantage of the same application lifecycle as Guest Executables and Reliable Services. That means I can create a <code>SetupEntryPoint</code>, and run it as <code>Administrator</code> to set up my SMB Global Mapping on-demand.</p><h4 id=defining-the-setupentrypoint>Defining the SetupEntryPoint <a href=#defining-the-setupentrypoint class=anchor>üîó</a></h4><p>In <code>ServiceManifest.xml</code>, I&rsquo;m launching a .bat file prior to running my container, which then launches a PowerShell script. Would love to make this simpler, but this is what I have working as of today. Below are the important snippets - <strong>please</strong> check out the GitHub repo - it has annotations, tips & tricks, and the full source:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;CodePackage</span> <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;Code&#34;</span> <span style=color:#a6e22e>Version=</span><span style=color:#e6db74>&#34;1.0.0&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;SetupEntryPoint&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ExeHost&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;Program&gt;</span>setup.bat<span style=color:#f92672>&lt;/Program&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;WorkingFolder&gt;</span>CodePackage<span style=color:#f92672>&lt;/WorkingFolder&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/ExeHost&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/SetupEntryPoint&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;EntryPoint&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;ContainerHost&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;ImageName&gt;</span>acanthamoeba/minecraft-server:nanoserver-1709<span style=color:#f92672>&lt;/ImageName&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/ContainerHost&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/EntryPoint&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/CodePackage&gt;</span>
</span></span></code></pre></div><h4 id=the-bat-file>The .bat file <a href=#the-bat-file class=anchor>üîó</a></h4><p>I didn&rsquo;t see a quick & easy way to run a PowerShell script, so the batch file just invokes PowerShell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>powershell.exe -ExecutionPolicy Bypass -Command <span style=color:#e6db74>&#34;.\AddSMBGlobalMapping.ps1&#34;</span>
</span></span></code></pre></div><h4 id=the-ps1-script>The .ps1 script <a href=#the-ps1-script class=anchor>üîó</a></h4><p>The PowerShell script does all the real work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Create the SMB Global Mapping</span>
</span></span><span style=display:flex><span>$password = ConvertTo-SecureString $account_key -AsPlainText -Force
</span></span><span style=display:flex><span>$cred = New-Object System.Management.Automation.PSCredential -ArgumentList <span style=color:#e6db74>&#34;Azure\$account_name&#34;</span>, $password
</span></span><span style=display:flex><span>New-SmbGlobalMapping -RemotePath $mapping_remote_target -Credential $cred
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Symlink the SMB Global Mapping to a folder on the node (this lets me avoid tracking drive letters!)</span>
</span></span><span style=display:flex><span>pushd D:\smbglobalmappings
</span></span><span style=display:flex><span>New-Item -ItemType SymbolicLink -Name minecraft -Target $mapping_remote_target -Force
</span></span></code></pre></div><h4 id=running-setupentrypoint-as-administrator>Running SetupEntryPoint as Administrator <a href=#running-setupentrypoint-as-administrator class=anchor>üîó</a></h4><p>Finally, I need to run this all as Administrator, so I&rsquo;ve got the following in <code>ApplicationManifest.xml</code> to tell Service Fabric to run <code>SetupEntryPoint</code> with elevated permissions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;Policies&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;RunAsPolicy</span> <span style=color:#a6e22e>CodePackageRef=</span><span style=color:#e6db74>&#34;Code&#34;</span> <span style=color:#a6e22e>UserRef=</span><span style=color:#e6db74>&#34;SetupAdminUser&#34;</span> <span style=color:#a6e22e>EntryPointType=</span><span style=color:#e6db74>&#34;Setup&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/Policies&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;Principals&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;Users&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;User</span> <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;SetupAdminUser&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;MemberOf&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;SystemGroup</span> <span style=color:#a6e22e>Name=</span><span style=color:#e6db74>&#34;Administrators&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/MemberOf&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/User&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/Users&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/Principals&gt;</span>
</span></span></code></pre></div><h3 id=2-mapping-the-container-volume>2. Mapping the Container Volume <a href=#2-mapping-the-container-volume class=anchor>üîó</a></h3><p>Finally, I need to map that symlink&rsquo;d SMB Global Mapping to the data folder inside my container. That takes place in <code>ApplicationManifest.xml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;Policies&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;ContainerHostPolicies</span> <span style=color:#a6e22e>CodePackageRef=</span><span style=color:#e6db74>&#34;Code&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;Volume</span> <span style=color:#a6e22e>Source=</span><span style=color:#e6db74>&#34;D:\smbglobalmappings\minecraft&#34;</span> <span style=color:#a6e22e>Destination=</span><span style=color:#e6db74>&#34;C:\data&#34;</span> <span style=color:#a6e22e>IsReadOnly=</span><span style=color:#e6db74>&#34;false&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/ContainerHostPolicies&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/Policies&gt;</span>
</span></span></code></pre></div><h2 id=results>Results <a href=#results class=anchor>üîó</a></h2><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/success.gif alt="Nailed it!"></p></p><p>It works great! I&rsquo;m able to deploy one or more instances of Minecraft as a Windows Container to a Service Fabric cluster, with each pointing to its own data. I can take down a node and let Service Fabric take care of putting everything on a new node, and then have it reconnect to storage with minimal downtime - I&rsquo;m talking seconds, not minutes or hours.</p><h3 id=what-went-well>What Went Well <a href=#what-went-well class=anchor>üîó</a></h3><ul><li>Stateful Windows Containers on Service Fabric are a viable & real scenario! If that&rsquo;s what you need, give it a try!</li><li>Not much additional setup on top of having a basic container running.</li><li>With some minor tweaks, you can actually deploy all of this from Azure Cloud Shell, Bash on Windows, Ubuntu, etc. :) I&rsquo;m comfortable with a code-centric workflow, and Service Fabric development works well in that setting.</li></ul><h3 id=what-was-difficult>What Was Difficult <a href=#what-was-difficult class=anchor>üîó</a></h3><ul><li>There are inherently a lot of moving parts - VMs, a Service Fabric cluster, node setup, and container volume mappings. It can be overwhelming if you&rsquo;re not deliberate about what you&rsquo;re doing.</li><li>There wasn&rsquo;t an easy way to get all of this running with a <a href=https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-docker-compose target=_blank rel=noopener>Docker Compose deployment (preview)</a>, so you&rsquo;ll need to roll up your sleeves & dive into the XML.</li><li>Azure Files is not currently (Feb 2018) designed for high-throughput scenarios. Target throughput is <code>60 MiB/sec</code> per the <a href=https://docs.microsoft.com/en-us/azure/storage/files/storage-files-scale-targets target=_blank rel=noopener>Azure Files scalability and performance targets</a>. Things are always changing, so be sure to check the official docs to see if there are any changes in the future.</li><li>Java (specifically OpenJDK 8) and Windows Containers were a real pain. I experienced application timeouts & strange problems. Putting everything in a Hyper-V container made these go away at the expense of up-front resource allocation. See <em>Make JVM respect CPU and RAM limits</em> on the <a href=https://hub.docker.com/_/openjdk/ target=_blank rel=noopener>OpenJDK image</a> on Docker Hub for more details. I would pick a Hyper-V container over process affinity every day, but it&rsquo;s interesting reading. I can&rsquo;t redistribute the Oracle JRE, so I&rsquo;m not sure if it behaves differently.</li></ul><h3 id=next-steps>Next Steps <a href=#next-steps class=anchor>üîó</a></h3><p>For higher throughput using Premium Managed Disks - I see no reason why I shouldn&rsquo;t be able to configure <a href=https://blogs.msdn.microsoft.com/clustering/2017/08/10/container-storage-support-with-cluster-shared-volumes-csv-storage-spaces-direct-s2d-smb-global-mapping/ target=_blank rel=noopener>Storage Spaces Direct (S2D)</a> on a VM Scale Set + Service Fabric cluster. This moves the storage back to the cluster itself and gives me up to <code>250 MB/sec</code> throughput per disk, while keeping the benefits of not being tied to a specific node. I haven&rsquo;t tested this yet, but it sounds fun!</p><p>It&rsquo;s also now possible to <a href=https://github.com/Azure/vm-scale-sets/tree/master/preview/disk#attach-detach-rest-api-description target=_blank rel=noopener>attach a disk to a specific instance</a> of a VM Scale Set. In theory, that should let me change my SetupEntryPoint to mount a disk directly to a node.</p><p>Finally, the Service Fabric team is always working to improve the product, and they&rsquo;re <a href=https://github.com/Azure/service-fabric-issues/issues/452 target=_blank rel=noopener>working on a volume driver</a> for an upcoming release. Don&rsquo;t be surprised if this entire post is superseded in the near future!</p><h3 id=links>Links! <a href=#links class=anchor>üîó</a></h3><ul><li>Go to the GitHub repo! <a href=https://github.com/noelbundick/service-fabric-1709-demo target=_blank rel=noopener>noelbundick/service-fabric-1709-demo</a></li><li>The Dockerfile for Minecraft on Windows Containers is quite interesting too! <a href=https://github.com/noelbundick/minecraft-server target=_blank rel=noopener>noelbundick/minecraft-server</a></li><li>For Linux SF clusters, check out <a href=https://haishibai.blogspot.com/2017/03/setting-up-highly-available-minecraft.html target=_blank rel=noopener>Haishi&rsquo;s Blog</a></li></ul></div><div class=tags><a href=/tags/azure>azure</a>
<a href=/tags/service-fabric>service fabric</a>
<a href=/tags/windows-containers>windows containers</a>
<a href=/tags/minecraft>minecraft</a></div></section></main><section><ul class=post-list><li>2018-04-22
<a href=/posts/serverless-vsts-build-agents-with-azure-container-instances/>Serverless VSTS Build Agents with Azure Container Instances<h2></h2></a></li><li>2018-03-10
<a href=/posts/cross-compiling-kubernetes-on-windows-subsystem-for-linux/>Cross-compiling Kubernetes on Windows Subsystem for Linux<h2></h2></a></li><li>2018-03-02
<a href=/posts/using-openssh-server-as-a-tunnel-on-windows/>Using OpenSSH Server as a Tunnel on Windows<h2></h2></a></li><li>2018-02-24
<a href=/posts/frankenetes-serverless-kubernetes/>Frankenetes! Serverless Kubernetes<h2></h2></a></li><li>2018-02-10
<a href=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/>Running Windows Containers with Volumes on Azure Service Fabric<h2></h2></a></li><li>2018-01-27
<a href=/posts/using-the-azure-iot-devkit-with-linux/>Using the Azure IoT DevKit with Linux<h2></h2></a></li><li>2018-01-21
<a href=/posts/frankenetes-running-the-kubernetes-control-plane-on-azure-container-instances/>Frankenetes! Running the Kubernetes control plane on Azure Container Instances<h2></h2></a></li><li>2017-11-13
<a href=/posts/my-on-demand-azure-dev-box/>My On-Demand Azure Dev Box<h2></h2></a></li><li>2017-08-07
<a href=/posts/deploying-arm-templates-from-a-url/>Quick tip - Deploying ARM Templates from a URL<h2></h2></a></li><li>2017-08-03
<a href=/posts/fun-with-azure-container-instances/>Fun with Azure Container Instances<h2></h2></a></li></ul></section><footer id=footer><div id=social><a class=symbol href=https://www.github.com/noelbundick rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/acanthamoeba rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Noel Bundick</div></footer></body></html>