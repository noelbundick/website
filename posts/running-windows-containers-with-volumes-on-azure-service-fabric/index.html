<!doctype html><html lang=en-us><head><title>Running Windows Containers with Volumes on Azure Service Fabric | Noel Bundick</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Containers are rapidly becoming the de-facto choice for application packaging, distribution, and execution in the cloud. This newfound flexibility brings new challenges, particularly with stateful workloads like databases. With the advent of container orchestrators, it&rsquo;s no longer a safe assumption that the underlying data for your server is already directly connected to your host. Nodes fail and are dynamically scaled, but your app still needs its data.
Azure Service Fabric is a distributed systems platform that added support for containers a while back."><meta name=generator content="Hugo 0.108.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=/fontawesome/css/brands.min.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/tags>Tags</a></nav><main class=main><section id=single><h1 class=title>Running Windows Containers with Volumes on Azure Service Fabric</h1><div class=tip><time datetime="2018-02-10 15:56:10 +0000 UTC">Feb 10, 2018</time>
<span class=split>¬∑</span>
<span>2062 words</span>
<span class=split>¬∑</span>
<span>10 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#minecraft-i-choose-you>Minecraft, I choose you!</a></li><li><a href=#setting-up-a-cluster>Setting up a cluster</a></li><li><a href=#service-fabric-application-overview>Service Fabric Application Overview</a></li><li><a href=#how-does-the-container-storage-work>How Does the Container Storage Work?</a><ul><li><a href=#the-problem>The problem</a></li><li><a href=#a-solution>A solution</a></li></ul></li><li><a href=#deep-dive>Deep dive</a><ul><li><a href=#1-node-configuration>1. Node configuration</a></li><li><a href=#2-mapping-the-container-volume>2. Mapping the Container Volume</a></li></ul></li><li><a href=#results>Results</a><ul><li><a href=#what-went-well>What Went Well</a></li><li><a href=#what-was-difficult>What Was Difficult</a></li><li><a href=#next-steps>Next Steps</a></li><li><a href=#links>Links!</a></li></ul></li></ul></nav></div></details></aside><div class=content><p>Containers are rapidly becoming the de-facto choice for application packaging, distribution, and execution in the cloud. This newfound flexibility brings new challenges, particularly with stateful workloads like databases. With the advent of container orchestrators, it&rsquo;s no longer a safe assumption that the underlying data for your server is already directly connected to your host. Nodes fail and are dynamically scaled, but your app still needs its data.</p><p><a href=https://docs.microsoft.com/en-us/azure/service-fabric/ target=_blank rel=noopener>Azure Service Fabric</a> is a distributed systems platform that <a href=https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-containers-overview target=_blank rel=noopener>added support</a> for containers a while back. Windows Server 1709 has <a href=https://blogs.msdn.microsoft.com/clustering/2017/08/10/container-storage-support-with-cluster-shared-volumes-csv-storage-spaces-direct-s2d-smb-global-mapping/ target=_blank rel=noopener>greatly improved</a> container storage support options by adding SMB Global Mapping. I&rsquo;ve combined the two with great success and want to share, so that you can understand & replicate the concepts in your own environment.</p><blockquote><p>This post has a sibling repo on GitHub where you can steal code & follow along: <a href=https://github.com/noelbundick/service-fabric-1709-demo target=_blank rel=noopener>https://github.com/noelbundick/service-fabric-1709-demo</a></p></blockquote><h2 id=minecraft-i-choose-you>Minecraft, I choose you! <a href=#minecraft-i-choose-you class=anchor>üîó</a></h2><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/pokeball.jpg alt="Minecraft + Pok√©mon = awesome!"></p></p><p>First off - I need an app that reads & writes local state. Databases and legacy apps are the common pick, but I&rsquo;ll take any excuse I can to play video games at work, so I&rsquo;m choosing the <a href=https://hub.docker.com/r/acanthamoeba/minecraft-server/ target=_blank rel=noopener>Minecraft Windows Container image</a> that I created (as an excuse to play games while learning Windows Containers&mldr;)</p><p>If you feel like something a bit more enterprisey or &ldquo;real world&rdquo;, the <a href=https://hub.docker.com/r/microsoft/mssql-server-windows-developer/ target=_blank rel=noopener>SQL Server Developer Edition for Windows Containers</a> is eerily similar - it also uses a specialized protocol on a specific port, writes data to local storage, you have to accept the EULA, etc. If you want to give it a try, use <code>C:\temp</code> instead of <code>C:\data</code>, and use port <code>1433</code> instead of <code>25565</code></p><h2 id=setting-up-a-cluster>Setting up a cluster <a href=#setting-up-a-cluster class=anchor>üîó</a></h2><p>I have a few options here. First, the <a href=https://portal.azure.com target=_blank rel=noopener>Azure Portal</a> now supports Service Fabric clusters with Server 1709. To kick the tires & get started, it works great. I know I&rsquo;m also interested in trying Hyper-V containers, so I need a VM size that supports <a href=https://azure.microsoft.com/en-us/blog/nested-virtualization-in-azure/ target=_blank rel=noopener>nested virtualization</a> - the <code>Dv3</code> or <code>Ev3</code> series are what I need. I also want to expose port 25565 instead of port 80.</p><p>Okay, that&rsquo;s getting to be a lot of stuff to remember, so I&rsquo;m going to use an ARM template and check it into source control. That way, I can recreate this environment again after I tear down this cluster. The template I&rsquo;m using is available <a href=https://github.com/noelbundick/service-fabric-1709-demo/blob/master/sf-1709/template.json target=_blank rel=noopener>on GitHub</a>.</p><p>I&rsquo;m running the following commands in a PowerShell session:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># Create a cluster</span>
</span></span><span style=display:flex><span>az sf cluster create `
</span></span><span style=display:flex><span>  -g sf-<span style=color:#2aa198>1709</span> `
</span></span><span style=display:flex><span>  -l eastus `
</span></span><span style=display:flex><span>  --template<span style=color:#719e07>-file</span> sf-<span style=color:#2aa198>1709</span>/template.json `
</span></span><span style=display:flex><span>  --parameter<span style=color:#719e07>-file</span> sf-<span style=color:#2aa198>1709</span>/parameters.json `
</span></span><span style=display:flex><span>  --vault-name sf-<span style=color:#2aa198>1709</span> `
</span></span><span style=display:flex><span>  --certificate-subject-name sf-<span style=color:#2aa198>1709</span> `
</span></span><span style=display:flex><span>  --certificate-password <span style=color:#2aa198>&#39;Password#1234&#39;</span> `
</span></span><span style=display:flex><span>  --certificate-output-folder .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># Import cert</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Import-PfxCertificate</span> -FilePath <span style=color:#2aa198>&#39;.\sf-1709201802051346.pfx&#39;</span> -CertStoreLocation <span style=color:#2aa198>&#39;Cert:\CurrentUser\My\&#39;</span>
</span></span></code></pre></div><p>Cool, now I&rsquo;ve got a cluster up and running! Based on the params I gave it, I can visit it in Service Fabric Explorer at <code>https://sf-1709.eastus.cloudapp.azure.com:19080</code></p><blockquote><p>For more cluster creation tips, check out James Sturtevant&rsquo;s post: <a href=http://www.jamessturtevant.com/posts/Creating-a-secure-Service-Fabric-Cluster-in-two-commands/ target=_blank rel=noopener>Creating a secure Service Fabric cluster in two commands</a></p></blockquote><h2 id=service-fabric-application-overview>Service Fabric Application Overview <a href=#service-fabric-application-overview class=anchor>üîó</a></h2><p>First, it&rsquo;s important to understand the big picture of how Service Fabric handles applications, because it&rsquo;s easy to get lost without that initial context. You don&rsquo;t just run a block of code on Service Fabric - you first register it as a type of application. This application type is versioned, and describes what services (containers), parameters, configuration, etc. that are needed to run your app. Then, you create an instance of your app.</p><p>For my Minecraft example, my <code>ApplicationType</code>, version 1.0.0 describes the following:</p><ul><li>My app, by default, has a single instance of a Minecraft <code>Service</code><ul><li>That service runs the <code>acanthamoeba/minecraft-server:nanoserver-1709</code> container, with various environment variables configured</li><li>The service should expose 2 endpoints (TCP ports) - one for the game, and one for administration</li><li>I also need a startup script that runs as Administrator to configure my host before running the container</li></ul></li><li>I want to parameterize my app so I can run lots of Minecraft servers on my cluster - each one will have different ports, data folders, etc.</li><li>Finally, I want to limit how much CPU/memory I allocate to each Minecraft server</li></ul><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/sfoverview.png alt="Service Fabric application types and instances"></p></p><p>The above diagram shows an example representation of how this all works. Minecraft first gets set up as an ApplicationType, and when I create instances, that&rsquo;s when Service Fabric will launch containers & map ports. Think of the ApplicationType like a rubber stamp, and the Instance is the impression I get when I use it on a piece of paper. Those instances can differ (color of ink, type of paper, etc) but each impression came from the same stamp.</p><h2 id=how-does-the-container-storage-work>How Does the Container Storage Work? <a href=#how-does-the-container-storage-work class=anchor>üîó</a></h2><p>Let&rsquo;s do a deep dive into how I set up container storage. Normally with VM Scale Sets, you do something like attach a 100GB data disk to every instance. A naive approach to container volumes might look something like the following:</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/datadisk.png alt="Data disks attached to VMSS"></p></p><blockquote><p>If you&rsquo;re still learning containers, a quick note on container storage: it&rsquo;s important to understand that the data inside a container goes away when the container is destroyed. So first step is always to map a path from inside the container to a path outside the container. Ex: <code>C:\data</code> inside the container pointing to <code>D:\some_folder</code> on the host.</p></blockquote><h3 id=the-problem>The problem <a href=#the-problem class=anchor>üîó</a></h3><p>Okay, looks great! My container can die and I still have my data stored on a disk, backed by Azure Storage - which replicates it multiple times inside my datacenter. Done! Right?</p><p>Wait, hold on - remember how I said container orchestrators introduce new challenges? Let&rsquo;s see what this looks like when a node fails, or needs to be taken offline for security updates:</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/datadisk-failure.png alt="Data disks attached to VMSS - failure"></p></p><p>Not looking so great anymore. My data is indeed safe, but it&rsquo;s logically bound to a specific VM (Node 0). When Service Fabric reschedules my service, it&rsquo;s going to launch on a new node, see no data, and start from scratch. That&rsquo;s bad! Really bad! I&rsquo;m going to get a different set of data every time my service moves across nodes. I&rsquo;m actually in worse shape than if I were to just host my app on a VM at this point - I&rsquo;m tied to a specific node, but I&rsquo;m pretending that I&rsquo;m not.</p><h3 id=a-solution>A solution <a href=#a-solution class=anchor>üîó</a></h3><p>This is where SMB Global Mapping can really help me out. It&rsquo;s like <code>net use</code> on steroids - it can map an SMB share for all users at the OS level. And lucky for me, Azure Files provides a hosted SMB service that persists data independently of any given VM node (or even cluster!). Here&rsquo;s what my storage looks like when I&rsquo;ve configured everything:</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/smbglobalmapping.png alt="SMB Global Mapping"></p></p><p>Cool, so I&rsquo;ve offloaded my data onto Azure Files. Let&rsquo;s run through the same thought experiment - what happens when my container dies in this scenario?</p><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/smbglobalmapping-failure.png alt="SMB Global Mapping - failure"></p></p><p>Awesome! I&rsquo;ve got the mapping set up on the new node, pointing to the same Azure File share. My container reads the existing data, and can continue on. I&rsquo;ve lost no data, and to the players on my Minecraft server - they&rsquo;ve experienced a disconnect, but didn&rsquo;t completely lose everything in their world.</p><h2 id=deep-dive>Deep dive <a href=#deep-dive class=anchor>üîó</a></h2><p>This section explains what I&rsquo;m doing in the GitHub repo and why.</p><h3 id=1-node-configuration>1. Node configuration <a href=#1-node-configuration class=anchor>üîó</a></h3><p>First up, I need to create the SMB Global Mapping on the host. I could do this on all nodes manually, or with a CustomScript VM extension, but that&rsquo;s really tedious & not very dynamic. What if I want to have multiple Minecraft servers, with each on a different storage account or file share? Or what if I have a business requirement that says each customer&rsquo;s database must be segregated? The smart thing to do is to have Service Fabric configure my node on-demand whenever I want to run a container on it.</p><p>Thankfully, running containers on Service Fabric takes advantage of the same application lifecycle as Guest Executables and Reliable Services. That means I can create a <code>SetupEntryPoint</code>, and run it as <code>Administrator</code> to set up my SMB Global Mapping on-demand.</p><h4 id=defining-the-setupentrypoint>Defining the SetupEntryPoint <a href=#defining-the-setupentrypoint class=anchor>üîó</a></h4><p>In <code>ServiceManifest.xml</code>, I&rsquo;m launching a .bat file prior to running my container, which then launches a PowerShell script. Would love to make this simpler, but this is what I have working as of today. Below are the important snippets - <strong>please</strong> check out the GitHub repo - it has annotations, tips & tricks, and the full source:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;CodePackage</span> Name=<span style=color:#2aa198>&#34;Code&#34;</span> Version=<span style=color:#2aa198>&#34;1.0.0&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;SetupEntryPoint&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;ExeHost&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&lt;Program&gt;</span>setup.bat<span style=color:#268bd2>&lt;/Program&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&lt;WorkingFolder&gt;</span>CodePackage<span style=color:#268bd2>&lt;/WorkingFolder&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&lt;/ExeHost&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;/SetupEntryPoint&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;EntryPoint&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;ContainerHost&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&lt;ImageName&gt;</span>acanthamoeba/minecraft-server:nanoserver-1709<span style=color:#268bd2>&lt;/ImageName&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;/ContainerHost&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;/EntryPoint&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/CodePackage&gt;</span>
</span></span></code></pre></div><h4 id=the-bat-file>The .bat file <a href=#the-bat-file class=anchor>üîó</a></h4><p>I didn&rsquo;t see a quick & easy way to run a PowerShell script, so the batch file just invokes PowerShell:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>powershell.exe -ExecutionPolicy Bypass -Command <span style=color:#2aa198>&#34;.\AddSMBGlobalMapping.ps1&#34;</span>
</span></span></code></pre></div><h4 id=the-ps1-script>The .ps1 script <a href=#the-ps1-script class=anchor>üîó</a></h4><p>The PowerShell script does all the real work:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># Create the SMB Global Mapping</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$password</span> = <span style=color:#b58900>ConvertTo-SecureString</span> <span style=color:#268bd2>$account_key</span> -AsPlainText -Force
</span></span><span style=display:flex><span><span style=color:#268bd2>$cred</span> = <span style=color:#b58900>New-Object</span> System.Management.Automation.PSCredential -ArgumentList <span style=color:#2aa198>&#34;Azure\</span><span style=color:#268bd2>$account_name</span><span style=color:#2aa198>&#34;</span>, <span style=color:#268bd2>$password</span>
</span></span><span style=display:flex><span><span style=color:#b58900>New-SmbGlobalMapping</span> -RemotePath <span style=color:#268bd2>$mapping_remote_target</span> -Credential <span style=color:#268bd2>$cred</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># Symlink the SMB Global Mapping to a folder on the node (this lets me avoid tracking drive letters!)</span>
</span></span><span style=display:flex><span><span style=color:#b58900>pushd </span>D:\smbglobalmappings
</span></span><span style=display:flex><span><span style=color:#b58900>New-Item</span> -ItemType SymbolicLink -Name minecraft -Target <span style=color:#268bd2>$mapping_remote_target</span> -Force
</span></span></code></pre></div><h4 id=running-setupentrypoint-as-administrator>Running SetupEntryPoint as Administrator <a href=#running-setupentrypoint-as-administrator class=anchor>üîó</a></h4><p>Finally, I need to run this all as Administrator, so I&rsquo;ve got the following in <code>ApplicationManifest.xml</code> to tell Service Fabric to run <code>SetupEntryPoint</code> with elevated permissions:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;Policies&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;RunAsPolicy</span> CodePackageRef=<span style=color:#2aa198>&#34;Code&#34;</span> UserRef=<span style=color:#2aa198>&#34;SetupAdminUser&#34;</span> EntryPointType=<span style=color:#2aa198>&#34;Setup&#34;</span> <span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/Policies&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;Principals&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;Users&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;User</span> Name=<span style=color:#2aa198>&#34;SetupAdminUser&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&lt;MemberOf&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#268bd2>&lt;SystemGroup</span> Name=<span style=color:#2aa198>&#34;Administrators&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&lt;/MemberOf&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;/User&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;/Users&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/Principals&gt;</span>
</span></span></code></pre></div><h3 id=2-mapping-the-container-volume>2. Mapping the Container Volume <a href=#2-mapping-the-container-volume class=anchor>üîó</a></h3><p>Finally, I need to map that symlink&rsquo;d SMB Global Mapping to the data folder inside my container. That takes place in <code>ApplicationManifest.xml</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;Policies&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;ContainerHostPolicies</span> CodePackageRef=<span style=color:#2aa198>&#34;Code&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;Volume</span> Source=<span style=color:#2aa198>&#34;D:\smbglobalmappings\minecraft&#34;</span> Destination=<span style=color:#2aa198>&#34;C:\data&#34;</span> IsReadOnly=<span style=color:#2aa198>&#34;false&#34;</span> <span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;/ContainerHostPolicies&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/Policies&gt;</span>
</span></span></code></pre></div><h2 id=results>Results <a href=#results class=anchor>üîó</a></h2><p><p class=markdown-image><img src=/posts/running-windows-containers-with-volumes-on-azure-service-fabric/success.gif alt="Nailed it!"></p></p><p>It works great! I&rsquo;m able to deploy one or more instances of Minecraft as a Windows Container to a Service Fabric cluster, with each pointing to its own data. I can take down a node and let Service Fabric take care of putting everything on a new node, and then have it reconnect to storage with minimal downtime - I&rsquo;m talking seconds, not minutes or hours.</p><h3 id=what-went-well>What Went Well <a href=#what-went-well class=anchor>üîó</a></h3><ul><li>Stateful Windows Containers on Service Fabric are a viable & real scenario! If that&rsquo;s what you need, give it a try!</li><li>Not much additional setup on top of having a basic container running.</li><li>With some minor tweaks, you can actually deploy all of this from Azure Cloud Shell, Bash on Windows, Ubuntu, etc. :) I&rsquo;m comfortable with a code-centric workflow, and Service Fabric development works well in that setting.</li></ul><h3 id=what-was-difficult>What Was Difficult <a href=#what-was-difficult class=anchor>üîó</a></h3><ul><li>There are inherently a lot of moving parts - VMs, a Service Fabric cluster, node setup, and container volume mappings. It can be overwhelming if you&rsquo;re not deliberate about what you&rsquo;re doing.</li><li>There wasn&rsquo;t an easy way to get all of this running with a <a href=https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-docker-compose target=_blank rel=noopener>Docker Compose deployment (preview)</a>, so you&rsquo;ll need to roll up your sleeves & dive into the XML.</li><li>Azure Files is not currently (Feb 2018) designed for high-throughput scenarios. Target throughput is <code>60 MiB/sec</code> per the <a href=https://docs.microsoft.com/en-us/azure/storage/files/storage-files-scale-targets target=_blank rel=noopener>Azure Files scalability and performance targets</a>. Things are always changing, so be sure to check the official docs to see if there are any changes in the future.</li><li>Java (specifically OpenJDK 8) and Windows Containers were a real pain. I experienced application timeouts & strange problems. Putting everything in a Hyper-V container made these go away at the expense of up-front resource allocation. See <em>Make JVM respect CPU and RAM limits</em> on the <a href=https://hub.docker.com/_/openjdk/ target=_blank rel=noopener>OpenJDK image</a> on Docker Hub for more details. I would pick a Hyper-V container over process affinity every day, but it&rsquo;s interesting reading. I can&rsquo;t redistribute the Oracle JRE, so I&rsquo;m not sure if it behaves differently.</li></ul><h3 id=next-steps>Next Steps <a href=#next-steps class=anchor>üîó</a></h3><p>For higher throughput using Premium Managed Disks - I see no reason why I shouldn&rsquo;t be able to configure <a href=https://blogs.msdn.microsoft.com/clustering/2017/08/10/container-storage-support-with-cluster-shared-volumes-csv-storage-spaces-direct-s2d-smb-global-mapping/ target=_blank rel=noopener>Storage Spaces Direct (S2D)</a> on a VM Scale Set + Service Fabric cluster. This moves the storage back to the cluster itself and gives me up to <code>250 MB/sec</code> throughput per disk, while keeping the benefits of not being tied to a specific node. I haven&rsquo;t tested this yet, but it sounds fun!</p><p>It&rsquo;s also now possible to <a href=https://github.com/Azure/vm-scale-sets/tree/master/preview/disk#attach-detach-rest-api-description target=_blank rel=noopener>attach a disk to a specific instance</a> of a VM Scale Set. In theory, that should let me change my SetupEntryPoint to mount a disk directly to a node.</p><p>Finally, the Service Fabric team is always working to improve the product, and they&rsquo;re <a href=https://github.com/Azure/service-fabric-issues/issues/452 target=_blank rel=noopener>working on a volume driver</a> for an upcoming release. Don&rsquo;t be surprised if this entire post is superseded in the near future!</p><h3 id=links>Links! <a href=#links class=anchor>üîó</a></h3><ul><li>Go to the GitHub repo! <a href=https://github.com/noelbundick/service-fabric-1709-demo target=_blank rel=noopener>noelbundick/service-fabric-1709-demo</a></li><li>The Dockerfile for Minecraft on Windows Containers is quite interesting too! <a href=https://github.com/noelbundick/minecraft-server target=_blank rel=noopener>noelbundick/minecraft-server</a></li><li>For Linux SF clusters, check out <a href=https://haishibai.blogspot.com/2017/03/setting-up-highly-available-minecraft.html target=_blank rel=noopener>Haishi&rsquo;s Blog</a></li></ul></div><div class=tags><a href=/tags/azure>azure</a>
<a href=/tags/service-fabric>service fabric</a>
<a href=/tags/windows-containers>windows containers</a>
<a href=/tags/minecraft>minecraft</a></div></section></main><section><ul class=post-list><li>2021-10-14
<a href=/gists/optimizing-rust-container-builds/>Optimizing Rust container builds<h2></h2></a></li><li>2021-09-19
<a href=/gists/wsl2-container-development-with-moby/>WSL2 container development with Moby<h2></h2></a></li><li>2019-12-17
<a href=/gists/rdp-from-wsl/>RDP from WSL<h2></h2></a></li><li>2019-06-28
<a href=/gists/how-to-use-docker-build-secrets/>How to use Docker build secrets<h2></h2></a></li><li>2019-06-12
<a href=/gists/consuming-packages-from-a-private-azure-pipelines-python-artifact-feed/>Consuming packages from a private Azure Pipelines Python artifact feed<h2></h2></a></li><li>2019-01-13
<a href=/gists/gists-as-a-content-management-system/>Gists as a content management system<h2></h2></a></li><li>2019-01-12
<a href=/gists/azure-function-w--user-assigned-identity/>Azure Function w/ User Assigned Identity<h2></h2></a></li><li>2018-12-15
<a href=/gists/secure-code-execution-via-arm-template-and-azure-container-instances/>Secure code execution via ARM template and Azure Container Instances<h2></h2></a></li><li>2018-12-10
<a href=/gists/azure-redis-cli/>azure-redis-cli<h2></h2></a></li><li>2018-12-10
<a href=/gists/resize-azure-cloud-shell-storage/>Resize Azure Cloud Shell storage<h2></h2></a></li></ul></section><footer id=footer><div id=social><a class=symbol rel=me href=https://www.github.com/noelbundick><i class="fa-brands fa-github"></i></a>
<a class=symbol rel=me href=https://www.linkedin.com/in/noelbundick/><i class="fa-brands fa-linkedin"></i></a>
<a class=symbol rel=me href=https://hachyderm.io/@acanthamoeba><i class="fa-brands fa-mastodon"></i></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Noel Bundick</div></footer></body></html>