<!doctype html><html lang=en-us><head><title>Secure code execution via ARM template and Azure Container Instances | Noel Bundick</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Secure code execution via ARM template and Azure Container Instances ğŸ”—What is this? ğŸ”—It&rsquo;s a template to execute authenticated az commands from an ARM template deployment, without storing or passing credentials of any kind
Why did you make it? ğŸ”—I was recently looking to move my blog from Azure Web Apps to a static site hosted on Azure Storage.
I wanted to have an ARM template so I can stand up other sites / use as a reference, etc."><meta name=generator content="Hugo 0.107.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=/fontawesome/css/brands.min.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>â†</span>Home</a>
<a href=/tags>Tags</a></nav><main class=main><section id=single><h1 class=title>Secure code execution via ARM template and Azure Container Instances</h1><div class=tip><time datetime="2018-12-15 00:00:00 +0000 UTC">Dec 15, 2018</time>
<span class=split>Â·</span>
<span>339 words</span>
<span class=split>Â·</span>
<span>2 minute read</span><div><a href=https://gist.github.com/7378efa4b34206f6e32f39b1297dad35>view gist on GitHub</a></div></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#what-is-this>What is this?</a></li><li><a href=#why-did-you-make-it>Why did you make it?</a></li><li><a href=#how-does-it-work>How does it work?</a></li><li><a href=#next-steps>Next steps</a></li></ul></nav></div></details></aside><div class=content><h1 id=secure-code-execution-via-arm-template-and-azure-container-instances>Secure code execution via ARM template and Azure Container Instances <a href=#secure-code-execution-via-arm-template-and-azure-container-instances class=anchor>ğŸ”—</a></h1><h2 id=what-is-this>What is this? <a href=#what-is-this class=anchor>ğŸ”—</a></h2><p>It&rsquo;s a template to execute authenticated <code>az</code> commands from an ARM template deployment, <strong>without storing or passing credentials of any kind</strong></p><h2 id=why-did-you-make-it>Why did you make it? <a href=#why-did-you-make-it class=anchor>ğŸ”—</a></h2><p>I was recently looking to move <a href=https://www.noelbundick.com target=_blank rel=noopener>my blog</a> from Azure Web Apps to a static site hosted on Azure Storage.</p><p>I wanted to have an ARM template so I can stand up other sites / use as a reference, etc. Unfortunately, enabling the static website feature on Azure Storage is currently a data-plane operation, and ARM templates only execute against the data plane.</p><h2 id=how-does-it-work>How does it work? <a href=#how-does-it-work class=anchor>ğŸ”—</a></h2><p>The template creates</p><ul><li>A <a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview target=_blank rel=noopener>Managed Identity</a>, which I can use with some services to eliminate the need for Service Principals & passwords</li><li>A <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/overview target=_blank rel=noopener>Role Assignment</a> so that the Identity can take actions in my resource group</li><li>An <a href=https://docs.microsoft.com/en-us/azure/storage/ target=_blank rel=noopener>Azure Storage</a> account that I&rsquo;ll use to deploy a static website on</li><li>An <a href=https://docs.microsoft.com/en-us/azure/container-instances/ target=_blank rel=noopener>Azure Container Instance</a> that runs my bootstrap commands - here using the azure-cli</li></ul><p>To deploy, run the following 2 commands</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>az group create -n website -l westus
</span></span><span style=display:flex><span>az group deployment create -g website --template-file azuredeploy.json --parameters <span style=color:#268bd2>baseName</span><span style=color:#719e07>=</span>mystorageaccount
</span></span></code></pre></div><h2 id=next-steps>Next steps <a href=#next-steps class=anchor>ğŸ”—</a></h2><p>It seems to make sense to move the script out of the inline template - it&rsquo;s hard to read - might eventually hit some string lenght limits (I haven&rsquo;t checked or tested this yet). I could mount a GitRepo volume and pin to a specific commit here</p><p>To use with other non-Azure services, I&rsquo;d replace the <code>az storage blob</code> commands and instead use <code>az keyvault secret show</code> to download a secret from a preexisting Key Vault. There&rsquo;s a little bit more work in precreating the Identity outside of this template, making sure it&rsquo;s in the KV accessPolicies, and then pass the Idenitity as a parameter to the template - but the flow is logically the same. Once you have a secret from Key Vault, use it to run whatever script(s) you need, and then when the container is finished, the secret vanishes with it!</p><h3>azuredeploy.json</h3><script src="https://gist.github.com/7378efa4b34206f6e32f39b1297dad35.js?file=azuredeploy.json"></script></div><div class=tags><a href=/tags/gist>gist</a></div></section></main><section><ul class=post-list><li>2021-10-14
<a href=/gists/optimizing-rust-container-builds/>Optimizing Rust container builds<h2></h2></a></li><li>2021-09-19
<a href=/gists/wsl2-container-development-with-moby/>WSL2 container development with Moby<h2></h2></a></li><li>2019-12-17
<a href=/gists/rdp-from-wsl/>RDP from WSL<h2></h2></a></li><li>2019-06-28
<a href=/gists/how-to-use-docker-build-secrets/>How to use Docker build secrets<h2></h2></a></li><li>2019-06-12
<a href=/gists/consuming-packages-from-a-private-azure-pipelines-python-artifact-feed/>Consuming packages from a private Azure Pipelines Python artifact feed<h2></h2></a></li><li>2019-01-13
<a href=/gists/gists-as-a-content-management-system/>Gists as a content management system<h2></h2></a></li><li>2019-01-12
<a href=/gists/azure-function-w--user-assigned-identity/>Azure Function w/ User Assigned Identity<h2></h2></a></li><li>2018-12-15
<a href=/gists/secure-code-execution-via-arm-template-and-azure-container-instances/>Secure code execution via ARM template and Azure Container Instances<h2></h2></a></li><li>2018-12-10
<a href=/gists/azure-redis-cli/>azure-redis-cli<h2></h2></a></li><li>2018-12-10
<a href=/gists/resize-azure-cloud-shell-storage/>Resize Azure Cloud Shell storage<h2></h2></a></li></ul></section><footer id=footer><div id=social><a class=symbol rel=me href=https://www.github.com/noelbundick><i class="fa-brands fa-github"></i></a>
<a class=symbol rel=me href=https://www.linkedin.com/in/noelbundick/><i class="fa-brands fa-linkedin"></i></a>
<a class=symbol rel=me href=https://hachyderm.io/@acanthamoeba><i class="fa-brands fa-mastodon"></i></a></div><div class=copyright>Â© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Noel Bundick</div></footer></body></html>