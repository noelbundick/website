<!doctype html><html lang=en-us><head><title>How to use Docker build secrets | Noel Bundick</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="How to use Docker build secrets 🔗It&rsquo;s common to need access to secret data to fully build an application from scratch. Commonly, builds pull sources or binaries from a private repository that requires authentication - private PyPI, npm, NuGet, etc. It&rsquo;s also common to use a Dockerfile to perform application build and packaging when deploying apps as containers, to take advantage of an isolated environment. This presents a challenge, as we don&rsquo;t want any secrets (files, environment variables, etc) to be captured in our image layers."><meta name=generator content="Hugo 0.97.2"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.css><link rel=stylesheet href=/fontawesome/css/brands.min.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>←</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a></nav><main class=main><section id=single><h1 class=title>How to use Docker build secrets</h1><div class=tip><time datetime="2019-06-28 00:00:00 +0000 UTC">Jun 28, 2019</time>
<span class=split>·</span>
<span>310 words</span>
<span class=split>·</span>
<span>2 minute read</span><div><a href=https://gist.github.com/44c12b3c856e26a0521174150f75968c>view gist on GitHub</a></div></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#an-example>An example</a><ul><li><a href=#tldr>TL;DR:</a></li><li><a href=#color-commentary>Color commentary</a></li></ul></li></ul></nav></div></details></aside><div class=content><h1 id=how-to-use-docker-build-secrets>How to use Docker build secrets <a href=#how-to-use-docker-build-secrets class=anchor>🔗</a></h1><p>It&rsquo;s common to need access to secret data to fully build an application from scratch. Commonly, builds pull sources or binaries from a private repository that requires authentication - private PyPI, npm, NuGet, etc. It&rsquo;s also common to use a Dockerfile to perform application build and packaging when deploying apps as containers, to take advantage of an isolated environment. This presents a challenge, as we don&rsquo;t want any secrets (files, environment variables, etc) to be captured in our image layers.</p><p>Docker 18.09 added some <a href=https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-secret-information target=_blank rel=noopener>nice build enhancements</a>, including a feature called build secrets, that help us solve just this. The idea is simple: mount a volume at build time, use it in a <code>RUN</code> command, then don&rsquo;t include it in our final image.</p><h2 id=an-example>An example <a href=#an-example class=anchor>🔗</a></h2><p>This is an example of using build secrets with Python to pull from a private package repository. I&rsquo;m using this <a href=https://github.com/Azure-Samples/azure-pipelines-python/tree/master/src/simple_package target=_blank rel=noopener>simple_package</a> and I&rsquo;m also making the assumption that if you&rsquo;re reading this post, you have this problem and you already know how to build a Python package & upload it to a repository somewhere.</p><h3 id=tldr>TL;DR: <a href=#tldr class=anchor>🔗</a></h3><p>Run this, study the annotations as needed</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># Pass the path to your pip.conf (secret) and build an image</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>DOCKER_BUILDKIT</span><span style=color:#719e07>=</span><span style=color:#2aa198>1</span> docker build --secret <span style=color:#268bd2>id</span><span style=color:#719e07>=</span>pipconfig,src<span style=color:#719e07>=</span>/path/to/some/pip.conf -t myapp --progress<span style=color:#719e07>=</span>plain . 
</span></span><span style=display:flex><span>docker run --rm -it -p 5000:5000 myapp
</span></span></code></pre></div><h3 id=color-commentary>Color commentary <a href=#color-commentary class=anchor>🔗</a></h3><h4 id=dockerfile>Dockerfile <a href=#dockerfile class=anchor>🔗</a></h4><ul><li>It has to start with <code># syntax = docker/dockerfile:1.0-experimental</code> to light up the ability to use the new syntax</li><li>We reference a secret by <code>id</code>, in this case <code>pipconfig</code>. This should match the <code>id</code> you pass in during <code>docker build</code></li><li>We also set a destination to control where the mount lands. Otherwise it lands under <code>/run/secrets/{id}</code></li></ul><h4 id=docker-build><code>docker build</code> <a href=#docker-build class=anchor>🔗</a></h4><ul><li>BuildKit changes the output, so it can be hard to see what&rsquo;s going on. <code>--progress=plain</code> gives a more familiar &ldquo;Oh look, pip is installing packages&rdquo; experience</li></ul><h3>Dockerfile</h3><script src="https://gist.github.com/44c12b3c856e26a0521174150f75968c.js?file=Dockerfile"></script><h3>app.py</h3><script src="https://gist.github.com/44c12b3c856e26a0521174150f75968c.js?file=app.py"></script><h3>pip.conf</h3><script src="https://gist.github.com/44c12b3c856e26a0521174150f75968c.js?file=pip.conf"></script><h3>requirements.txt</h3><script src="https://gist.github.com/44c12b3c856e26a0521174150f75968c.js?file=requirements.txt"></script></div><div class=tags><a href=/tags/gist>gist</a></div></section></main><section><ul class=post-list><li>2021-10-14
<a href=/gists/optimizing-rust-container-builds/>Optimizing Rust container builds<h2></h2></a></li><li>2021-09-19
<a href=/gists/wsl2-container-development-with-moby/>WSL2 container development with Moby<h2></h2></a></li><li>2019-12-17
<a href=/gists/rdp-from-wsl/>RDP from WSL<h2></h2></a></li><li>2019-06-28
<a href=/gists/how-to-use-docker-build-secrets/>How to use Docker build secrets<h2></h2></a></li><li>2019-06-12
<a href=/gists/consuming-packages-from-a-private-azure-pipelines-python-artifact-feed/>Consuming packages from a private Azure Pipelines Python artifact feed<h2></h2></a></li><li>2019-01-13
<a href=/gists/gists-as-a-content-management-system/>Gists as a content management system<h2></h2></a></li><li>2019-01-12
<a href=/gists/azure-function-w--user-assigned-identity/>Azure Function w/ User Assigned Identity<h2></h2></a></li><li>2018-12-15
<a href=/gists/secure-code-execution-via-arm-template-and-azure-container-instances/>Secure code execution via ARM template and Azure Container Instances<h2></h2></a></li><li>2018-12-10
<a href=/gists/azure-redis-cli/>azure-redis-cli<h2></h2></a></li><li>2018-12-10
<a href=/gists/resize-azure-cloud-shell-storage/>Resize Azure Cloud Shell storage<h2></h2></a></li></ul></section><footer id=footer><div id=social><a class=symbol href=https://www.github.com/noelbundick><i class="fa-brands fa-github"></i></a>
<a class=symbol href=https://www.linkedin.com/in/noelbundick/><i class="fa-brands fa-linkedin"></i></a>
<a class=symbol href=https://twitter.com/acanthamoeba><i class="fa-brands fa-twitter"></i></a></div><div class=copyright>© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Noel Bundick</div></footer></body></html>